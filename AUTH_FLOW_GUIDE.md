# Authentication Flow Guide

## Overview
This app uses a **dual authentication system** combining **Firebase Authentication** (for frontend user management) and a **Backend API** (for Firestore data storage and business logic).

## ğŸ” How It Works

### **Registration Flow**
```
User enters details â†’ Backend creates Firestore user â†’ Firebase creates auth user â†’ Success
```

**Step-by-step:**
1. User fills registration form with email, username, password
2. **Backend API (`/auth/signup`)** is called first
   - Creates user document in Firestore
   - Hashes password with bcrypt
   - Returns JWT token for API access
3. **Firebase Authentication** creates the auth user
   - Uses same email/password
   - Stores user in Firebase Auth system
   - Updates display name
4. User is now authenticated in both systems

**Why backend first?**
- If Firebase Auth succeeds but backend fails, we'd have "orphan" auth users
- Backend-first ensures data consistency

### **Login Flow**
```
User enters credentials â†’ Backend validates & returns JWT â†’ Firebase signs in â†’ Profile loaded
```

**Step-by-step:**
1. User enters email/password
2. **Backend API (`/auth/login`)** validates credentials
   - Checks Firestore for user
   - Verifies password hash
   - Returns JWT token
   - Token stored in secure storage
3. **Firebase Authentication** signs in
   - Uses same email/password
   - Gets Firebase user object
   - Retrieves Firebase ID token (for future use)
4. **Backend API (`/users/me`)** loads full profile
   - Uses JWT token from step 2
   - Returns complete user data
   - Stores in memory for app use

### **Logout Flow**
```
Sign out from Firebase â†’ Clear JWT token â†’ Clear stored credentials
```

**Step-by-step:**
1. Firebase sign out
2. API service logout (clears tokens)
3. Delete all stored credentials from secure storage

## ğŸ“ Files Overview

### Frontend Files
- **`lib/services/auth_service.dart`** - Main authentication logic
  - Manages Firebase Auth
  - Calls Backend API endpoints
  - Stores tokens securely
  
- **`lib/services/api_service.dart`** - HTTP client for backend
  - `signup()` - POST /auth/signup
  - `login()` - POST /auth/login
  - `getMyProfile()` - GET /users/me
  - Auto-includes JWT in headers

- **`lib/providers/auth_provider.dart`** - State management
  - Wraps auth_service
  - Notifies UI of auth state changes

### Backend Files
- **`app/api/v1/auth.py`** - Auth endpoints
  - `POST /auth/signup` - Creates new user
  - `POST /auth/login` - Validates credentials
  
- **`app/services/auth_service.py`** - Auth business logic
  - Password hashing with bcrypt
  - JWT token generation
  - User validation

- **`app/services/firebase_service.py`** - Firestore operations
  - `create_user()` - Stores user in Firestore
  - `get_user_by_email()` - Retrieves user data
  - `update_user_profile()` - Updates user info

## ğŸ”‘ Token Management

### JWT Tokens (Backend API)
- Generated by backend during login/signup
- Stored in Flutter Secure Storage
- Automatically added to API requests
- Used to authenticate backend API calls

### Firebase ID Tokens (Future Use)
- Generated by Firebase Authentication
- Can be used for Firebase services (Storage, Functions)
- Can be sent to backend for verification
- Currently not being used but available

## âš™ï¸ Current Configuration

### Backend (Python/FastAPI)
- URL: `http://localhost:8000`
- Database: Cloud Firestore
- Authentication: JWT tokens (HS256)
- Password: bcrypt hashing

### Frontend (Flutter)
- Firebase Auth: Email/Password authentication
- Storage: Flutter Secure Storage for tokens
- HTTP Client: Dio with interceptors
- Platforms: Android, iOS, Web, Desktop

## ğŸš€ Testing the Flow

### Prerequisites
âœ… Firestore Database enabled in Firebase Console  
âœ… Email/Password auth enabled in Firebase Console  
âœ… Backend running on port 8000  
âœ… Firebase credentials configured  

### Test Registration
1. Open the app
2. Go to Sign Up screen
3. Enter:
   - Username: `testuser`
   - Email: `test@example.com`
   - Password: `Test123!`
4. Click Sign Up
5. Check console logs for success messages:
   ```
   âœ… Backend registration successful: <user_id>
   âœ… Firebase Auth user created: <firebase_uid>
   ```

### Test Login
1. Open the app
2. Go to Login screen
3. Enter registered email and password
4. Click Login
5. Check console logs:
   ```
   âœ… Backend login successful
   âœ… Firebase Auth login successful: <firebase_uid>
   ```

### Verify in Firebase Console
1. Go to Authentication tab - see user listed
2. Go to Firestore - see user document in `users` collection

## ğŸ› ï¸ Troubleshooting

### "Backend registration failed"
- Check backend is running: `http://localhost:8000/docs`
- Verify Firestore is enabled
- Check backend console for errors

### "Firebase setup failed"
- Verify Email/Password auth is enabled in Firebase Console
- Check Firebase config in `main.dart`
- Look for Firebase errors in console

### "Backend login failed"
- User may not exist in Firestore
- Check password is correct
- Verify JWT token generation works

### "Token expired" errors
- JWT tokens have expiration (default: 7 days)
- User needs to login again
- Clear secure storage and re-authenticate

## ğŸ”’ Security Notes

### Current Implementation
âœ… Passwords hashed with bcrypt  
âœ… JWT tokens for API authentication  
âœ… Secure storage for tokens  
âœ… HTTPS recommended for production  

### Production Recommendations
- [ ] Use HTTPS for backend API
- [ ] Implement token refresh mechanism
- [ ] Add rate limiting on auth endpoints
- [ ] Enable Firebase App Check
- [ ] Implement proper token expiry handling
- [ ] Add biometric authentication option
- [ ] Revoke old service account keys
- [ ] Use Firebase ID token verification in backend

## ğŸ“ API Endpoints Reference

### Authentication
```
POST /auth/signup
Body: { email, password, username, full_name }
Returns: { access_token, token_type, user_id }

POST /auth/login
Body: { email, password }
Returns: { access_token, token_type, user_id }
```

### User Profile
```
GET /users/me
Headers: { Authorization: Bearer <token> }
Returns: { user_id, email, username, full_name, ... }

PUT /users/me
Headers: { Authorization: Bearer <token> }
Body: { full_name, ... }
Returns: { message, updated_user }
```

## ğŸ¯ Next Steps

1. **Enable Firebase Services** (if not done)
   - Firestore Database
   - Email/Password Authentication

2. **Test Complete Flow**
   - Register new user
   - Login with credentials
   - Verify data in Firestore

3. **Enhance Security**
   - Implement token refresh
   - Add biometric auth
   - Enable App Check

4. **Additional Features**
   - Password reset
   - Email verification
   - Social auth (Google, Apple)
   - Multi-factor authentication

---

## ğŸ“ Support

If you encounter issues:
1. Check backend logs: `python -m uvicorn app.main:app --reload`
2. Check frontend logs: Look in VS Code Debug Console
3. Verify Firebase Console settings
4. Review error messages in the UI

**Remember:** Always check that both Firebase services (Firestore + Email/Password auth) are enabled before testing!
